## PRD_Viral.md — If I were you: 관계별 인식 리포트(바이럴)

**요약 (3–5줄)**
Self(내가 보는 나)와 *관계별 Others* (친구/회사/연인/가족)가 보는 나의 차이를 지도처럼 시각화하고, **PGI (Perception Gap Index)**로 격차를 수치화합니다. A가 링크를 보내고 B들이 응답하면 관계별 Top 유형/분포/합의도와 Self↔Top 차이 축을 레이더·스택바·Gap 카드로 제공합니다. **n≥3**일 때만 상세 인사이트·공유 카드(OG)가 해금되어 바이럴 루프를 형성하며, 전 과정은 **결정 패킷(decision_packet)**으로 봉인되어 재현성과 책임 추적이 보장됩니다.

```yaml
---
version: "1.0"
date: "2025-09-19"
product: "If I were you — Relation Perception Report"
domains: ["backend","frontend","data","growth","safety"]
owner: "PM: 이지율"
source_of_truth: "PRD_Viral.md"
---
```

### 0) 전제 (Assumptions)

- 기존 Self/Other 문항과 16유형 매핑 재사용, 관계 태그 5종: `friend|coworker|spouse|family|other`.
- 바이럴 인센티브: 응답 n≥3 → 상세 인사이트/차트/OG 해금, n<3은 요약 카드만 제공.
- 공유는 링크 접근 전용, 기본 비공개. 결과 URL은 `noindex`/`X-Robots-Tag`, 토큰 만료 필수.
- 기술 스택: BE=FastAPI + PostgreSQL + Redis, FE=React + Vite + Chart.js, OG=서버 측 렌더(Satori/Sharp 또는 Headless Chrome).

---

### 1) 비전 · 문제 · 타깃

- **비전:** 관계별 “시선 지도”로 오해를 가시화하고 안전한 대화를 촉진.
- **문제:** 맥락(회사/친구)에 따라 평가가 갈리지만 정량화·시각화 수단 부족.
- **타깃:** 20~40대 개인 사용자(커플·직장·동아리). 공유 친화 경험을 선호하는 집단.

---

### 2) 범위 / 비범위

- **In:** A→B 초대 플로우, 관계 태그 수집, 관계별 집계(Top/분포/합의도), PGI 지수, 레이더·스택바·Gap 카드, OG 카드 자동 생성, 언락형 인센티브, GA4 이벤트, A/B 실험.
- **Out (1차):** 댓글/자유서술 공개, 조직 권한 관리, 결제, 모바일 앱, 다국어.

---

### 3) 사용자 흐름

1. **A**: 랜딩 → Self 입력/확인 → 관계별 초대 링크 자동 생성(정원·만료 포함).
2. **B**: 초대 링크 → 관계 선택 → 32문항 응답(익명/기명 옵션).
3. 응답 n≥3 달성: 상세 인사이트 해금 → 관계별 카드/PGI/텍스트 리포트 확인.
4. **A**: OG 카드 생성 → 스토리/피드/X 공유 → 신규 유입 유도.

---

### 4) 핵심 개념 / 지표 정의

- **Top 유형 (관계 r):** `argmax(count_r[type])`, `p_top = count_r[top]/n_r`.
- **합의도 (Confidence):** `conf_r = 1 - H(p)/log(16)`; `H(p) = -Σ p_i log p_i`.
- **문자 거리:** Self vs GroupTop의 4축 차이 개수(0~4) = 해밍 거리.
- **PGI_r:** `25 * distance(Self, Top_r) * (0.5 + 0.5 * conf_r)` ∈ [0,100].
- **PGI 전체:** 관계별 가중 평균 (기본 1.0, 연인 1.2, 회사 1.1 선택 가능).

---

### 5) 기능 요구 (Functional Requirements)

| ID        | 요약           | 설명                                           | 의존성  | 위험    | 수락 기준 (요약)                                  |
|-----------|----------------|------------------------------------------------|--------|--------|---------------------------------------------------|
| R-V101    | 초대 생성       | 관계 태그 포함 링크/QR, 만료·정원 설정             | Auth/DB | 남용   | 201 응답, 서명 토큰, 429 레이트리밋 적용             |
| R-V102    | 관계 응답 수집   | 32문항 + 관계 태그 + 익명/기명 옵션                | R-V101 | 봇     | P95<1s(동시 20명), 중복 제출 차단, RFC9457 오류 매핑 |
| R-V103    | 집계/Top/분포   | 16유형 분포, Top1/Top2, p_top, n 저장             | R-V102 | 계산오류 | 샘플 대비 오차 0, TTL 5분 캐시, 단위테스트 통과        |
| R-V104    | 합의도/PGI      | 엔트로피 기반 신뢰도, 관계별/전체 PGI 계산         | R-V103 | 해석착시 | 경계값 테스트, 평균/극단 케이스 검증                 |
| R-V105    | 시각화          | 레이더(4축)·스택바(16×관계)·Gap 카드 렌더          | R-V104 | 과밀   | 360/768/1024 반응형, 30fps, 접근성 라벨             |
| R-V106    | 언락 로직       | n≥3 상세 인사이트/OG 해금, n<3 잠금 UI             | R-V103 | 프라이버시 | 잠금 일관성, 안내 배지, “더 받기” CTA 작동             |
| R-V107    | OG 이미지       | 1200×630 / 1080×1920 템플릿 + 워터마크             | R-V106 | 성능   | <200ms 생성, 캐시키=데이터 해시, CDN 캐시            |
| R-V108    | 텍스트 리포트    | 규칙 기반 설명(LLM 옵션)                          | R-V104 | 과장   | 단정 금지, 감정적 표현 제한, 폴백 문구 제공           |
| R-V109    | GA4/실험        | 이벤트/UTM 전송, A/B 실험 배리에이션 관리          | 공통     | 누락   | 이벤트 수집률 >95%, 실험 로그 남김                  |
| R-V110    | 표준 오류/관측   | RFC9457 Problem Details, X-Request-ID, OTel 전파 | 공통     | 누락   | 스냅샷 테스트, TraceJoin ≥99%                      |
| R-V111    | 안전/프라이버시   | noindex, k-익명, 토큰 만료                         | 공통     | 유출   | k<3 비공개, 로봇 차단 헤더, 토큰 만료 확인           |

---

### 6) 비기능 요구 (NFR)

- API 평균 <500ms / P95 <1s, 오류율 <1% (k6 + APM).
- Web Vitals P75: LCP ≤2.5s, INP ≤200ms, CLS ≤0.1.
- 접근성: WCAG 2.2 AA (키보드, 라벨, 대비, 모션 감소).
- 관측성: 요청 ID 100%, 오류 100% 샘플링, 정상 ≥20% 샘플링.
- 보안: TLS, 토큰/도메인 허용목록, 레이트리밋/봇 억제, 결과 noindex.

---

### 7) 결과 화면 요구사항

- **요약 헤더:** “관계별 인식 지도”, Self 유형, 응답자 수, PGI 전체 값.
- **관계별 카드:** Top1/Top2 + 비율, 합의도 뱃지(높음/중간/낮음), 레이더, 16유형 스택바, Gap 축 목록.
- **OG/공유 영역:** 이미지 미리보기, 채널 버튼, “나도 받아보기” QR/URL.
- **잠금 상태:** n<3 회색 잠금 카드 + “3명 더 모으면 해금” 안내.

---

### 8) 데이터 품질 · 안전

- n<3 집단은 요약 통계만 노출(세부 수치/댓글 비공개).
- 봇/남용 방지: IP/UA/응답시간 히스토그램, 허니팟, 중복 토큰 차단.
- 텍스트 생성 시 비단정·비진단·비모욕 가이드 준수, 실패 시 규칙문 폴백.

---

### 9) KPI · 계측

- K-Factor(초대수 × 전환율), 공유 CTR, 언락 달성률, OG 노출수.
- 평균 응답자 수/세션, PGI 중앙값, 합의도 평균, 페이지 체류/스크롤 완료율.

---

### 10) 릴리즈 수락 기준

1. E2E: A 초대 → B 응답 ≥3 → 집계 → PGI → OG 공유 (무플레이크 5 시나리오) 통과.
2. 집계/PGI/합의도 계산 스냅샷 올그린(경계·빈분포·단일분포 포함).
3. n<3 잠금/프라이버시 정책 작동, 결과 URL `noindex` 헤더 확인.
4. RFC9457 오류·요청 ID·OTel Trace 조인 검증.
5. Web Vitals P75 목표 충족 (랩 + 필드).

---

### 11) 리스크 · 완화

- **소수 의견 왜곡:** 합의도(엔트로피) 병기, Top만 강조 금지, “의견 다양” 라벨 제공.
- **프라이버시:** n<3 잠금, OG 개인식별 제거, 토큰 만료.
- **봇 유입:** 레이트리밋, 타임투컴플리트, 허니팟, IP/UA 휴리스틱.

---

### 12) Traceability (발췌)

- R-V103/104 → T-Calc-PGI/Conf → M-PGI/M-Confidence.
- R-V106/107 → T-Unlock/OG → M-UnlockRate/M-ShareCTR.
- R-V110/111 → T-RFC9457/Noindex → M-TraceJoin/M-Privacy.

---

### 부록 A. 참고 문헌

- RFC 9457: Problem Details for HTTP APIs — https://www.rfc-editor.org/rfc/rfc9457.html
- Chart.js Radar & Bar — https://www.chartjs.org/docs/latest/
- Web Vitals — https://web.dev/articles/vitals
- Ad placement policies — https://support.google.com/adsense/answer/1346295
- WCAG 2.2 — https://www.w3.org/TR/WCAG22/

