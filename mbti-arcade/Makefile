# MBTI & Arcade Web Service Makefile

# Python ê´€ë ¨ ë³€ìˆ˜
PYTHON = python
PIP = pip
UVICORN = uvicorn
PYTEST = pytest

# í”„ë¡œì íŠ¸ ê´€ë ¨ ë³€ìˆ˜
APP_NAME = app.main:app
HOST = 0.0.0.0
PORT = 8000
DEV_PORT = 8001

# ê°€ìƒí™˜ê²½ ê´€ë ¨
VENV_NAME = venv
VENV_ACTIVATE = $(VENV_NAME)/Scripts/activate

# Docker ê´€ë ¨
DOCKER_IMAGE = mbti-arcade
DOCKER_CONTAINER = mbti-arcade-container

# ê¸°ë³¸ íƒ€ê²Ÿ
.PHONY: help
help:
	@echo "MBTI & Arcade Web Service - ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@echo ""
	@echo "ê°œë°œ í™˜ê²½ ì„¤ì •:"
	@echo "  make install     - ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "  make venv        - ê°€ìƒí™˜ê²½ ìƒì„± ë° í™œì„±í™”"
	@echo "  make setup       - ì „ì²´ ê°œë°œ í™˜ê²½ ì„¤ì •"
	@echo ""
	@echo "ì„œë²„ ì‹¤í–‰:"
	@echo "  make run         - ê°œë°œ ì„œë²„ ì‹¤í–‰ (í¬íŠ¸ 8000)"
	@echo "  make dev         - ê°œë°œ ì„œë²„ ì‹¤í–‰ (í¬íŠ¸ 8001)"
	@echo "  make prod        - í”„ë¡œë•ì…˜ ì„œë²„ ì‹¤í–‰"
	@echo ""
	@echo "í…ŒìŠ¤íŠ¸:"
	@echo "  make test        - í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make test-verbose - ìƒì„¸í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo ""
	@echo "Docker:"
	@echo "  make docker-build - Docker ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  make docker-run   - Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
	@echo "  make docker-stop  - Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€"
	@echo "  make docker-clean - Docker ì´ë¯¸ì§€ ë° ì»¨í…Œì´ë„ˆ ì •ë¦¬"
	@echo ""
	@echo "ìœ í‹¸ë¦¬í‹°:"
	@echo "  make clean        - ìºì‹œ íŒŒì¼ ì •ë¦¬"
	@echo "  make format       - ì½”ë“œ í¬ë§·íŒ…"
	@echo "  make lint         - ì½”ë“œ ë¦°íŒ…"
	@echo "  make check        - ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"

# ê°œë°œ í™˜ê²½ ì„¤ì •
.PHONY: install
install:
	@echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	$(PIP) install -r requirements.txt

.PHONY: venv
venv:
	@echo "ğŸ ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
	$(PYTHON) -m venv $(VENV_NAME)
	@echo "âœ… ê°€ìƒí™˜ê²½ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
	@echo "ğŸ’¡ ê°€ìƒí™˜ê²½ì„ í™œì„±í™”í•˜ë ¤ë©´:"
	@echo "   PowerShell: $(VENV_NAME)/Scripts/Activate.ps1"
	@echo "   Command Prompt: $(VENV_NAME)/Scripts/activate.bat"

.PHONY: setup
setup: venv
	@echo "ğŸ”§ ì „ì²´ ê°œë°œ í™˜ê²½ ì„¤ì • ì¤‘..."
	@echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	$(PIP) install -r requirements.txt
	@echo "âœ… ê°œë°œ í™˜ê²½ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

# ì„œë²„ ì‹¤í–‰
.PHONY: run
run:
	@echo "ğŸš€ ê°œë°œ ì„œë²„ ì‹¤í–‰ ì¤‘... (http://$(HOST):$(PORT))"
	$(PYTHON) -m $(UVICORN) $(APP_NAME) --reload --host $(HOST) --port $(PORT)

.PHONY: dev
dev:
	@echo "ğŸš€ ê°œë°œ ì„œë²„ ì‹¤í–‰ ì¤‘... (http://$(HOST):$(DEV_PORT))"
	$(PYTHON) -m $(UVICORN) $(APP_NAME) --reload --host $(HOST) --port $(DEV_PORT)

.PHONY: prod
prod:
	@echo "ğŸš€ í”„ë¡œë•ì…˜ ì„œë²„ ì‹¤í–‰ ì¤‘... (http://$(HOST):$(PORT))"
	$(PYTHON) -m $(UVICORN) $(APP_NAME) --host $(HOST) --port $(PORT) --workers 4

# í…ŒìŠ¤íŠ¸
.PHONY: test
test:
	@echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTHON) -m $(PYTEST) test_mbti.py -v

.PHONY: test-verbose
test-verbose:
	@echo "ğŸ§ª ìƒì„¸í•œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	$(PYTHON) -m $(PYTEST) test_mbti.py -v -s

# Docker ê´€ë ¨
.PHONY: docker-build
docker-build:
	@echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker build -t $(DOCKER_IMAGE) .

.PHONY: docker-run
docker-run:
	@echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘... (http://localhost:$(PORT))"
	docker run -d --name $(DOCKER_CONTAINER) -p $(PORT):$(PORT) $(DOCKER_IMAGE)

.PHONY: docker-stop
docker-stop:
	@echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
	docker stop $(DOCKER_CONTAINER) || true
	docker rm $(DOCKER_CONTAINER) || true

.PHONY: docker-clean
docker-clean: docker-stop
	@echo "ğŸ³ Docker ì´ë¯¸ì§€ ë° ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
	docker rmi $(DOCKER_IMAGE) || true
	docker system prune -f

# ìœ í‹¸ë¦¬í‹°
.PHONY: clean
clean:
	@echo "ğŸ§¹ ìºì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache
	rm -rf .coverage
	rm -rf htmlcov
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ!"

.PHONY: format
format:
	@echo "ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ì¤‘..."
	$(PYTHON) -m black app/ test_mbti.py
	$(PYTHON) -m isort app/ test_mbti.py

.PHONY: lint
lint:
	@echo "ğŸ” ì½”ë“œ ë¦°íŒ… ì¤‘..."
	$(PYTHON) -m flake8 app/ test_mbti.py
	$(PYTHON) -m pylint app/ test_mbti.py

.PHONY: check
check: format lint test
	@echo "âœ… ëª¨ë“  ê²€ì‚¬ ì™„ë£Œ!"

# Windows PowerShellìš© ë³„ì¹­
.PHONY: run-ps
run-ps:
	@echo "ğŸš€ PowerShellì—ì„œ ê°œë°œ ì„œë²„ ì‹¤í–‰ ì¤‘... (http://$(HOST):$(PORT))"
	powershell -Command "cd $(CURDIR); $(PYTHON) -m $(UVICORN) $(APP_NAME) --reload --host $(HOST) --port $(PORT)"

.PHONY: dev-ps
dev-ps:
	@echo "ğŸš€ PowerShellì—ì„œ ê°œë°œ ì„œë²„ ì‹¤í–‰ ì¤‘... (http://$(HOST):$(DEV_PORT))"
	powershell -Command "cd $(CURDIR); $(PYTHON) -m $(UVICORN) $(APP_NAME) --reload --host $(HOST) --port $(DEV_PORT)"

# ë¹ ë¥¸ ì‹œì‘ì„ ìœ„í•œ ë³„ì¹­
.PHONY: start
start: run

.PHONY: quick
quick: install run 