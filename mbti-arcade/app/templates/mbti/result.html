{% extends "base.html" %}

{% block title %}MBTI κ²°κ³Ό - {{ mbti_type }} - MBTI & Arcade Web Service{% endblock %}

{% block head %}
    {{ super() }}
    {% if robots_meta %}
    <meta name="robots" content="{{ robots_meta }}">
    {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="text-center mb-8">
        {% if pair_token %}
        <h1 class="text-4xl font-bold text-gray-800 mb-4">π“ κ΄€κ³„λ³„ μΈμ‹ μ§€λ„</h1>
        <p class="text-base text-gray-600">Self ν…μ¤νΈμ™€ μ΄λ€ μ‘λ‹µμ„ λΉ„κµν•΄ μ„λ΅κ°€ λλΌλ” λ¨μµμ„ μ‚΄ν΄λ³΄μ„Έμ”.</p>
        {% else %}
        <h1 class="text-4xl font-bold text-gray-800 mb-4">π‰ λ‚΄ MBTI κ²°κ³Ό</h1>
        <p class="text-base text-gray-600">λλ‚μ— κ°€κΉμ΄ λ¬Έμ¥μ„ μ„ νƒν•΄ μ£Όμ…”μ„ κ³ λ§μ›μ”.</p>
        {% endif %}
    </div>

    <!-- MBTI Result Card -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg shadow-xl p-8 mb-8">
        <div class="text-center">
            <div class="text-8xl mb-4">π§ </div>
            <h2 class="text-5xl font-bold mb-2">{{ mbti_type }}</h2>
            <h3 class="text-2xl font-semibold mb-4">{{ result.title }}</h3>
            <p class="text-xl opacity-90">{{ result.description }}</p>
        </div>
    </div>

    <!-- Score Breakdown -->
    <div class="grid md:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">μ„±ν–¥ λ¶„μ„</h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">μ™Έν–¥μ„± (E)</span>
                        <span class="text-blue-600">{{ scores.E }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">λ‚΄ν–¥μ„± (I)</span>
                        <span class="text-blue-600">{{ scores.I }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: {{ scores.E }}%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">κ°κ° (S)</span>
                        <span class="text-green-600">{{ scores.S }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">μ§κ΄€ (N)</span>
                        <span class="text-green-600">{{ scores.N }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: {{ scores.S }}%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">μ‚¬κ³  (T)</span>
                        <span class="text-purple-600">{{ scores.T }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">κ°μ • (F)</span>
                        <span class="text-purple-600">{{ scores.F }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-purple-600 h-2 rounded-full" style="width: {{ scores.T }}%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">νλ‹¨ (J)</span>
                        <span class="text-orange-600">{{ scores.J }}%</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">μΈμ‹ (P)</span>
                        <span class="text-orange-600">{{ scores.P }}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-600 h-2 rounded-full" style="width: {{ scores.J }}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">MBTI μ ν• μ„¤λ…</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[0] }} - {{ "μ™Έν–¥μ„±" if mbti_type[0] == "E" else "λ‚΄ν–¥μ„±" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[0] == "E" %}
                        ν™λ°ν•κ³  μ‚¬κµμ μ΄λ©°, λ‹¤λ¥Έ μ‚¬λλ“¤κ³Όμ μƒνΈμ‘μ©μ„ ν†µν•΄ μ—λ„μ§€λ¥Ό μ–»μµλ‹λ‹¤.
                        {% else %}
                        μ΅°μ©ν•κ³  μ‹ μ¤‘ν•λ©°, νΌμλ§μ μ‹κ°„μ„ ν†µν•΄ μ—λ„μ§€λ¥Ό μ–»μµλ‹λ‹¤.
                        {% endif %}
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[1] }} - {{ "κ°κ°" if mbti_type[1] == "S" else "μ§κ΄€" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[1] == "S" %}
                        κµ¬μ²΄μ μ΄κ³  μ‹¤μ©μ μΈ μ •λ³΄λ¥Ό μ„ νΈν•λ©°, ν„μ¬μ μ‚¬μ‹¤μ— μ§‘μ¤‘ν•©λ‹λ‹¤.
                        {% else %}
                        μ¶”μƒμ μ΄κ³  λ―Έλμ§€ν–¥μ μ΄λ©°, κ°€λ¥μ„±κ³Ό ν¨ν„΄μ„ μ°Ύμµλ‹λ‹¤.
                        {% endif %}
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[2] }} - {{ "μ‚¬κ³ " if mbti_type[2] == "T" else "κ°μ •" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[2] == "T" %}
                        λ…Όλ¦¬μ μ΄κ³  κ°κ΄€μ μΈ λ¶„μ„μ„ ν†µν•΄ κ²°μ •μ„ λ‚΄λ¦½λ‹λ‹¤.
                        {% else %}
                        κ°μ •κ³Ό κ°€μΉλ¥Ό κ³ λ ¤ν•μ—¬ κ²°μ •μ„ λ‚΄λ¦½λ‹λ‹¤.
                        {% endif %}
                    </p>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-800">{{ mbti_type[3] }} - {{ "νλ‹¨" if mbti_type[3] == "J" else "μΈμ‹" }}</h4>
                    <p class="text-sm text-gray-600">
                        {% if mbti_type[3] == "J" %}
                        κ³„νμ„ μ„Έμ°κ³  κ·Έλ€λ΅ λ”°λ¥΄λ” κ²ƒμ„ μ„ νΈν•©λ‹λ‹¤.
                        {% else %}
                        μƒν™©μ— λ”°λΌ μ μ—°ν•κ² λ€μ‘ν•λ” κ²ƒμ„ μ„ νΈν•©λ‹λ‹¤.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- κ²°κ³Ό μΉ΄λ“ μ•„λμ— μ‚½μ… -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4">π“ λ‘ κ΄€μ  λΉ„κµ</h3>
      <canvas id="radar-chart"
              hx-get="/api/report/{{ pair_token }}"
              hx-trigger="load"
              hx-ext="json"
              class="w-full h-72"></canvas>
    </div>

    <!-- κ°μΈν™”λ μ΅°μ–Έ μΉ΄λ“ -->
    {% if pair_token %}
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h3 class="text-xl font-bold text-gray-800 mb-4">π’΅ κ°μΈν™”λ μ΅°μ–Έ</h3>
        <div id="advice" 
             hx-get="/api/advice/{{ pair_token }}" 
             hx-trigger="load" 
             hx-swap="innerHTML"
             class="min-h-[100px] flex items-center justify-center">
            <div class="text-gray-500">μ΅°μ–Έμ„ λ¶λ¬μ¤λ” μ¤‘...</div>
        </div>
    </div>
    {% endif %}

    {% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script>
      document.body.addEventListener('htmx:afterOnLoad', evt=>{
        if(evt.detail.target.id !== 'radar-chart') return;
        const {labels, datasets} = evt.detail.xhr.response;
        const ctx = evt.detail.target.getContext('2d');
        new Chart(ctx, {
          type:'radar',
          data:{labels,
            datasets:datasets.map(d=>({
              label: d.role === 'me' ? 'λ‚΄ κ΄€μ ' : 'μƒλ€ κ΄€μ ',
              data: labels.map(l=>d.scores[l]),
              fill:true
            }))
          },
          options:{responsive:true, plugins:{legend:{position:'top'}}}
        });
      });

      // μ΅°μ–Έ API μ‘λ‹µ μ²λ¦¬
      document.body.addEventListener('htmx:afterOnLoad', evt => {
        if(evt.detail.requestConfig.path.startsWith('/api/advice/')) {
          try {
            const {advice} = JSON.parse(evt.detail.xhr.responseText);
            evt.target.innerHTML = `<div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
              <p class="text-purple-800 leading-relaxed">${advice}</p>
            </div>`;
          } catch (e) {
            evt.target.innerHTML = `<div class="p-4 bg-red-50 rounded-lg border border-red-200">
              <p class="text-red-800">μ΅°μ–Έμ„ λ¶λ¬μ¤λ” μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.</p>
            </div>`;
          }
        }
      });
    </script>
    {% include "mbti/_preview_script.html" %}
    {% endblock %}

    <!-- μΉκµ¬ ν‰κ°€ κ²°κ³ΌμΈ κ²½μ° μ¶”κ°€ μ •λ³΄ ν‘μ‹ -->
    {% if friend_name %}
    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-purple-800 mb-3">π‘¥ μΉκµ¬ ν‰κ°€ μ™„λ£!</h3>
        <p class="text-purple-700 mb-2">
            <strong>{{ (responder_name or 'μµλ…') }}</strong>λ‹μ΄
            <span class="font-semibold">{{ friend_name }}</span>λ‹μ MBTIλ¥Ό ν‰κ°€ν–μµλ‹λ‹¤.
            {% if friend_relationship %}<span class="text-purple-600">(κ΄€κ³„: {{ friend_relationship }})</span>{% endif %}
        </p>
        {% if friend_mbti %}
        <p class="text-sm text-purple-600 mb-4">μ°Έκ³ μ©μΌλ΅ μ…λ ¥λ μ‹¤μ  MBTI: {{ friend_mbti }}</p>
        {% endif %}
        <div class="space-x-4">
            <a href="/mbti/friend"
               class="inline-block bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                π‘¥ λ‹¤λ¥Έ μΉκµ¬ ν‰κ°€ν•κΈ°
            </a>
            <a href="/mbti"
               class="inline-block bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                π§  λ‚΄ MBTI ν…μ¤νΈν•κΈ°
            </a>
        </div>
    </div>
    {% endif %}

    {% if pair_token %}
    {% include "mbti/_preview_widget.html" %}
    {% endif %}

    <!-- Action Buttons -->
    <div class="flex flex-col gap-3 sm:flex-row sm:justify-center sm:space-x-4 text-center">
        <a href="/mbti/share?name={{ evaluator_name or 'μ‚¬μ©μ' }}&mbti={{ mbti_result }}" 
           class="inline-block bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors">
            π“¤ μ΄λ€ λ§ν¬ λ‹¤μ‹ λ§λ“¤κΈ°
        </a>
        <a href="/mbti/self-test" 
           class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
            π”„ Self ν…μ¤νΈ λ‹¤μ‹ ν•κΈ°
        </a>
        <a href="/mbti/types" 
           class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors">
            π“‹ λ¨λ“  μ ν• λ³΄κΈ°
        </a>
    </div>
    
    <!-- Disclaimer -->
    <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <p class="text-sm text-yellow-800 text-center">
            <strong>TIP.</strong> κ²°κ³Όλ” λ€ν™”λ¥Ό μ‹μ‘ν•κΈ° μ„ν• μ°Έκ³ μ©μΌλ΅ ν™μ©ν•΄ μ£Όμ„Έμ”.
        </p>
    </div>
</div>
{% endblock %} 
