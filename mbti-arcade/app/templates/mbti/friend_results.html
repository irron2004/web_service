{% extends "base.html" %}

{% block title %}{{ friend_info.display_name or friend_info.name }} 인식 결과 - MBTI Insight Hub{% endblock %}

{% block head %}
    {{ super() }}
    {% if robots_meta %}
    <meta name="robots" content="{{ robots_meta }}">
    {% endif %}
{% endblock %}

{% block content %}
{% set owner_name = friend_info.display_name or friend_info.name or '친구' %}
{% set perceived_mbti = mbti_type %}
{% set owner_mbti = friend_info.mbti %}
{% if pair_token %}
    {% set invite_url = request.url_for('invite_public', token=pair_token) %}
{% else %}
    {% set invite_url = '' %}
{% endif %}
<div class="mx-auto max-w-4xl space-y-10 py-10">
    <section class="rounded-3xl bg-gradient-to-br from-indigo-600 via-sky-500 to-emerald-500 px-6 py-10 text-white shadow-xl">
        <div class="flex flex-col items-center gap-6 text-center md:flex-row md:text-left">
            {% if friend_info.avatar %}
            <img src="{{ friend_info.avatar }}" alt="{{ owner_name }} avatar" class="h-24 w-24 rounded-full border-4 border-white/60 object-cover shadow-lg" referrerpolicy="no-referrer">
            {% else %}
            <div class="flex h-24 w-24 items-center justify-center rounded-full border-4 border-white/60 text-3xl font-semibold shadow-lg">
                {{ owner_name[:2] if owner_name else '🙂' }}
            </div>
            {% endif %}
            <div class="space-y-3">
                <p class="inline-flex items-center justify-center rounded-full bg-white/15 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white/90">Friend Insight</p>
                <h1 class="text-3xl font-bold leading-tight md:text-4xl">{{ owner_name }} 님에 대한 인식 결과</h1>
                <p class="text-sm text-white/90 md:text-base">
                    익명 응답이 누적되면 Self ↔ Others 차이를 더 깊게 살펴볼 수 있어요. 초대 링크는 계속 열려 있으니 추가로 공유해 보세요.
                </p>
            </div>
        </div>
    </section>

    <section class="grid gap-6 md:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
        <div class="space-y-6 rounded-3xl border border-slate-200 bg-white p-8 shadow-xl">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <p class="text-sm font-semibold text-slate-600">친구들이 본 {{ owner_name }}의 MBTI</p>
                    <p class="text-3xl font-bold text-slate-900">{{ perceived_mbti }}</p>
                    {% if owner_mbti %}
                    <p class="text-sm text-slate-500">Self 보고: <span class="font-semibold text-indigo-600">{{ owner_mbti }}</span></p>
                    {% else %}
                    <p class="text-sm text-slate-500">Self MBTI가 입력되면 비교 카드가 활성화됩니다.</p>
                    {% endif %}
                </div>
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">
                    <p><strong>응답</strong> {{ statistics.total_evaluations }}건</p>
                    <p><strong>평균 점수</strong> {{ '%.1f'|format(statistics.average_score) }} / 100</p>
                </div>
            </div>

            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-slate-900">주요 축별 비율</h2>
                <div class="grid gap-4 md:grid-cols-2">
                    {% set axes = [('E','I'), ('S','N'), ('T','F'), ('J','P')] %}
                    {% for first, second in axes %}
                    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                        <p class="text-sm font-semibold text-slate-600">{{ first }}/{{ second }}</p>
                        <div class="mt-3 flex items-center gap-3">
                            <span class="text-lg font-bold text-indigo-600">{{ scores[first] }}</span>
                            <div class="h-2 flex-1 overflow-hidden rounded-full bg-slate-200">
                                <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-emerald-500" style="width: {{ scores[first] }}%"></div>
                            </div>
                            <span class="text-sm font-semibold text-slate-500">{{ second }} {{ scores[second] }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="space-y-3">
                <h2 class="text-lg font-semibold text-slate-900">유형 요약</h2>
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6">
                    <p class="text-sm font-semibold text-indigo-600">{{ result.title }}</p>
                    <p class="mt-2 text-sm text-slate-600">{{ result.description }}</p>
                </div>
            </div>
        </div>

        <aside class="space-y-6">
            <div class="rounded-3xl border border-emerald-200 bg-emerald-50 p-6 text-sm text-emerald-800">
                <h2 class="text-base font-semibold text-emerald-900">응답이 더 모이면?</h2>
                <p class="mt-2">관계 그룹별 인사이트, 공감 지수, Self ↔ Others 비교가 자동으로 열립니다. 초대 링크를 계속 공유해 주세요.</p>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-white p-6 text-sm text-slate-600 shadow-lg">
                <h2 class="text-base font-semibold text-slate-900">초대 관리</h2>
                <ul class="mt-3 space-y-2">
                    <li>• 초대 링크는 여전히 유효하며, 검색엔진에 노출되지 않습니다.</li>
                    <li>• 표시명을 바꾸고 싶다면 <a href="/mbti/share" class="font-semibold text-indigo-600 hover:text-indigo-700">새 초대</a>를 생성하세요.</li>
                    <li>• Self 테스트 결과를 입력하면 비교 카드가 함께 노출됩니다.</li>
                </ul>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-slate-50 p-6 text-sm text-slate-600">
                <h2 class="text-base font-semibold text-slate-900">공유 다시하기</h2>
                <p class="mt-2">아래 버튼으로 초대 링크를 다시 복사할 수 있어요.</p>
                <div class="mt-3 flex flex-col gap-3">
                    <input id="shareUrlSecondary" type="text" readonly value="{{ invite_url }}" class="rounded-xl border border-slate-300 px-4 py-3 text-xs text-slate-600 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500">
                    <button type="button" class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-4 py-3 text-xs font-semibold text-white shadow hover:bg-indigo-700" data-copy-target="shareUrlSecondary">링크 복사</button>
                </div>
            </div>
        </aside>
    </section>
</div>

<script>
function copyToClipboard(inputId, trigger) {
    const input = document.getElementById(inputId);
    if (!input || !input.value) {
        return;
    }
    const text = input.value;
    const button = trigger;
    const success = () => {
        if (!button) {
            return;
        }
        const original = button.textContent;
        button.textContent = '복사 완료!';
        button.classList.add('bg-emerald-600');
        setTimeout(() => {
            button.textContent = original;
            button.classList.remove('bg-emerald-600');
        }, 2000);
    };

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(success).catch(() => {
            fallbackCopy(input, success);
        });
    } else {
        fallbackCopy(input, success);
    }
}

function fallbackCopy(input, onSuccess) {
    input.focus();
    input.select();
    try {
        const ok = document.execCommand('copy');
        if (ok && typeof onSuccess === 'function') {
            onSuccess();
        }
    } catch (err) {
        console.warn('copy failed', err);
    }
}

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-copy-target]').forEach(function (button) {
        button.addEventListener('click', function () {
            const target = button.getAttribute('data-copy-target');
            copyToClipboard(target, button);
        });
    });
});
</script>
{% endblock %}
