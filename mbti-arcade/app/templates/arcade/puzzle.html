{% extends "base.html" %}

{% block title %}í¼ì¦ ê²Œì„ - MBTI & Arcade Web Service{% endblock %}

{% block head %}
<style>
    .puzzle-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }
    .puzzle-board {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2px;
        background: #333;
        padding: 10px;
        border-radius: 8px;
    }
    .puzzle-tile {
        width: 80px;
        height: 80px;
        background: #4ade80;
        border: none;
        border-radius: 4px;
        font-size: 24px;
        font-weight: bold;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    .puzzle-tile:hover {
        background: #22c55e;
        transform: scale(1.05);
    }
    .puzzle-tile.empty {
        background: #6b7280;
        cursor: default;
    }
    .puzzle-tile.empty:hover {
        background: #6b7280;
        transform: none;
    }
    .game-info {
        display: flex;
        gap: 20px;
        font-size: 1.2em;
        font-weight: bold;
    }
    .controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="puzzle-container">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">ğŸ§© ìˆ«ì í¼ì¦</h1>
    
    <div class="game-info">
        <div>ì´ë™ íšŸìˆ˜: <span id="moves">0</span></div>
        <div>ì‹œê°„: <span id="time">00:00</span></div>
    </div>
    
    <div class="puzzle-board" id="puzzleBoard">
        <!-- í¼ì¦ íƒ€ì¼ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
    
    <div class="controls">
        <p class="text-gray-600 mb-2">ëª©í‘œ: 1ë¶€í„° 8ê¹Œì§€ ìˆœì„œëŒ€ë¡œ ë°°ì—´í•˜ì„¸ìš”</p>
        <button id="shuffleBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
            ì„ê¸°
        </button>
        <button id="solveBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors ml-2">
            í•´ë‹µ ë³´ê¸°
        </button>
    </div>
    
    <div class="mt-4">
        <a href="/arcade" class="text-blue-600 hover:text-blue-800 underline">
            â† ì•„ì¼€ì´ë“œë¡œ ëŒì•„ê°€ê¸°
        </a>
    </div>
</div>

<script>
class PuzzleGame {
    constructor() {
        this.board = [1, 2, 3, 4, 5, 6, 7, 8, 0]; // 0ì€ ë¹ˆ ì¹¸
        this.moves = 0;
        this.startTime = null;
        this.timer = null;
        this.gameRunning = false;
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.render();
    }
    
    bindEvents() {
        document.getElementById('shuffleBtn').addEventListener('click', () => this.shuffle());
        document.getElementById('solveBtn').addEventListener('click', () => this.solve());
    }
    
    shuffle() {
        this.moves = 0;
        this.startTime = Date.now();
        this.gameRunning = true;
        
        // Fisher-Yates ì…”í”Œ ì•Œê³ ë¦¬ì¦˜
        for (let i = this.board.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.board[i], this.board[j]] = [this.board[j], this.board[i]];
        }
        
        // í•´ê²° ê°€ëŠ¥í•œ ìƒíƒœì¸ì§€ í™•ì¸
        if (!this.isSolvable()) {
            this.shuffle(); // ë‹¤ì‹œ ì„ê¸°
            return;
        }
        
        this.startTimer();
        this.render();
        document.getElementById('moves').textContent = this.moves;
    }
    
    isSolvable() {
        let inversions = 0;
        for (let i = 0; i < this.board.length - 1; i++) {
            for (let j = i + 1; j < this.board.length; j++) {
                if (this.board[i] !== 0 && this.board[j] !== 0 && this.board[i] > this.board[j]) {
                    inversions++;
                }
            }
        }
        return inversions % 2 === 0;
    }
    
    startTimer() {
        if (this.timer) clearInterval(this.timer);
        this.timer = setInterval(() => {
            if (this.gameRunning) {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('time').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }
    
    moveTile(index) {
        if (!this.gameRunning) return;
        
        const emptyIndex = this.board.indexOf(0);
        if (this.isAdjacent(index, emptyIndex)) {
            [this.board[index], this.board[emptyIndex]] = [this.board[emptyIndex], this.board[index]];
            this.moves++;
            document.getElementById('moves').textContent = this.moves;
            this.render();
            
            if (this.isSolved()) {
                this.gameOver();
            }
        }
    }
    
    isAdjacent(index1, index2) {
        const row1 = Math.floor(index1 / 3);
        const col1 = index1 % 3;
        const row2 = Math.floor(index2 / 3);
        const col2 = index2 % 3;
        
        return (Math.abs(row1 - row2) === 1 && col1 === col2) ||
               (Math.abs(col1 - col2) === 1 && row1 === row2);
    }
    
    isSolved() {
        for (let i = 0; i < this.board.length - 1; i++) {
            if (this.board[i] !== i + 1) return false;
        }
        return this.board[8] === 0;
    }
    
    solve() {
        this.board = [1, 2, 3, 4, 5, 6, 7, 8, 0];
        this.gameRunning = false;
        if (this.timer) clearInterval(this.timer);
        this.render();
    }
    
    gameOver() {
        this.gameRunning = false;
        if (this.timer) clearInterval(this.timer);
        
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        alert(`ì¶•í•˜í•©ë‹ˆë‹¤! í¼ì¦ì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!\nì´ë™ íšŸìˆ˜: ${this.moves}\nì†Œìš” ì‹œê°„: ${timeString}`);
    }
    
    render() {
        const boardElement = document.getElementById('puzzleBoard');
        boardElement.innerHTML = '';
        
        this.board.forEach((value, index) => {
            const tile = document.createElement('button');
            tile.className = `puzzle-tile ${value === 0 ? 'empty' : ''}`;
            tile.textContent = value === 0 ? '' : value;
            tile.addEventListener('click', () => this.moveTile(index));
            boardElement.appendChild(tile);
        });
    }
}

// ê²Œì„ ì‹œì‘
new PuzzleGame();
</script>
{% endblock %} 