# Calculate Service Overview

> **참고**
> 이제 Calculate Math 서비스 코드는 별도 저장소([irron2004/calculate_math](https://github.com/irron2004/calculate_math))에서 관리됩니다. 아래 내용은 구조를 설명하기 위한 문서이며, 최신 구현은 새 저장소를 참고하세요.

## 서비스 구성

`calculate_math`는 FastAPI 기반의 초등 수학 문제 연습 서비스를 제공합니다. 핵심 컴포넌트는 다음과 같습니다.

- **API 라우터**: `/api/problems`를 통해 카테고리별 문제 세트를 JSON 으로 제공합니다.
- **페이지 라우터**: `/`, `/problems` 등 웹 페이지를 렌더링하며, 모든 HTML 응답에는 `X-Robots-Tag: noindex` 헤더를 추가해 검색 노출을 차단합니다.
- **Invite 라우터**: Self → Invite → Aggregate 학습 여정을 지원하기 위해 초대 토큰을 생성하고 공유 페이지를 제공합니다.

## Invite 흐름

Invite 기능은 연습 결과를 가족이나 친구와 공유할 수 있도록 설계되었습니다.

1. **초대 생성 (`POST /api/invites`)**
   - 요청 본문에는 공유할 `category`와 선택적으로 `summary`(총 문제 수, 정답 수)를 담습니다.
   - 서버는 `InviteStore`를 통해 고유 토큰을 발급하고, 만료 시간이 포함된 응답을 반환합니다.
   - 응답에는 `/share/{token}` 형태의 공유 URL과 QR 코드 생성을 위한 데이터가 포함됩니다.

2. **초대 조회 (`GET /api/invites/{token}`)**
   - 유효한 토큰이면 동일한 초대 정보를 반환합니다.
   - 만료되었거나 존재하지 않으면 404 Problem Detail 을 돌려줍니다.

3. **초대 만료 (`DELETE /api/invites/{token}`)**
   - 사용자가 즉시 초대를 비활성화할 수 있습니다.
   - 만료된 토큰은 다시 조회할 수 없으며, 공유 페이지는 410 상태 코드와 만료 안내 메시지를 노출합니다.

4. **공유 페이지 (`GET /share/{token}`)**
   - 초대 정보가 유효하면 카테고리, 생성/만료 시각, 정답 요약을 보여주고 문제 페이지로 이동하는 버튼을 제공합니다.
   - 만료된 토큰은 안내 메시지와 함께 재초대 유도 버튼을 렌더링합니다.
   - 모든 공유 페이지 응답은 `X-Robots-Tag: noindex`와 `Cache-Control: no-store` 헤더를 강제 적용합니다.

## 프론트엔드 연동

`problems.html`에는 Invite 섹션이 추가되어 다음과 같은 UX를 제공합니다.

- Invite 버튼을 통해 토큰을 생성하고, 복사/QR/만료 액션을 수행할 수 있습니다.
- 요약 영역은 현재 연습 현황을 전송하여 초대 응답의 정답률을 즉시 표시합니다.
- `base.html` 헤더의 Invite 버튼은 해당 섹션으로 스크롤 이동을 지원합니다.
- 환경 변수나 설정으로 카테고리가 비활성화된 경우 문제 페이지의 Invite 영역은 자동으로 비활성화되어 안내 문구만 보여주고 API 호출을 차단합니다.

## 카테고리 가드레일

- 런타임 설정에서 유효한 카테고리가 하나도 없으면 홈 화면 CTA는 `/problems` 기본 보기로 연결됩니다.
- 문제 페이지는 Invite 버튼을 비활성화하고 경고 메시지를 표시해 잘못된 설정으로 인한 공유 시도를 방지합니다.
- 공유 페이지 역시 남아 있는 카테고리를 다시 계산하여, 만료·삭제된 카테고리에 접근할 경우 410 응답과 함께 재초대 유도 문구를 제공합니다.

## 앱 구성 및 라우터 주입

- FastAPI 앱은 `calculate_math/app/__init__.py`에서 생성되며, `Jinja2Templates` 인스턴스를 애플리케이션 상태와 페이지/초대 라우터에 동시에 주입해 템플릿 엔진을 공유합니다.
- 이전 브랜치와의 호환성을 위해 라우터 모듈에 `get_router()` 팩토리가 존재하는 경우에는 해당 함수를 통해 라우터를 등록하고, 모듈 수준 `router` 객체만 노출될 때는 이를 그대로 사용합니다.
- 이렇게 구성하면 오래된 브랜치에서 병합되던 라우터 초기화 방식과 최신 Invite 흐름을 모두 안전하게 공존시킬 수 있어 충돌을 방지합니다.

## 테스트 커버리지

`calculate_math/tests/test_invites.py`는 다음 시나리오를 검증합니다.

- 초대 생성 시 토큰, 만료 시각, 요약 데이터가 올바르게 반환된다.
- 생성된 토큰을 조회할 수 있으며 공유 페이지는 200 응답을 제공한다.
- 토큰 만료 후 API 및 공유 페이지에서 404/410 상태 코드를 돌려준다.
- 존재하지 않는 카테고리로 초대를 생성하면 404 에러가 발생한다.

이 문서는 초대 기능을 포함한 서비스 흐름을 빠르게 파악하기 위한 요약 자료입니다.
