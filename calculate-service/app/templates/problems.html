{% extends "base.html" %}

{% block title %}{{ category_display }} ë¬¸ì œ â€” 360Me Math Lab{% endblock %}

{% block content %}
<div class="mx-auto w-full max-w-5xl space-y-12 px-4 py-12 sm:px-6 lg:px-8">
    <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-sky-500 via-primary to-purple-500 px-6 py-14 text-white shadow-2xl sm:px-10">
        <div class="absolute inset-0 opacity-15" aria-hidden="true"
             style="background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.28) 0, transparent 55%),
                    radial-gradient(circle at 80% 10%, rgba(255,255,255,0.2) 0, transparent 45%);"></div>
        <div class="relative z-10 space-y-5 text-center">
            <span class="inline-flex items-center justify-center rounded-full bg-white/10 px-4 py-1 text-xs font-semibold uppercase tracking-widest text-white/80">
                Practice Stage Â· {{ category_display }} Â· WCAG 2.2 AA
            </span>
            <h1 class="text-4xl font-bold tracking-tight sm:text-5xl">{{ category_display }} ë¬¸ì œ ì—°ìŠµ</h1>
            <p class="text-base text-white/85 sm:text-lg">
                ë¬¸ì œë¥¼ ì½ê³  ë‹µì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ í”¼ë“œë°±ì´ ì œê³µë©ë‹ˆë‹¤. Self â†’ Invite â†’ Aggregate ì—¬ì •ì˜ Practice ë‹¨ê³„ì— í•´ë‹¹í•©ë‹ˆë‹¤.
                ì •ë‹µë¥  ìš”ì•½ê³¼ í•™ìŠµ ë…¸íŠ¸ ë§í¬ë¡œ ë‹¤ìŒ ë‹¨ê³„ì— ëŒ€ë¹„í•˜ì„¸ìš”.
            </p>
            <div class="flex flex-wrap items-center justify-center gap-3">
                <a href="/" class="inline-flex items-center gap-2 rounded-full bg-white/90 px-4 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-white">
                    <span aria-hidden="true">ğŸ </span> í—ˆë¸Œ í™ˆ
                </a>
                <a href="http://localhost:8080" class="inline-flex items-center gap-2 rounded-full border border-white/40 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/10">
                    <span aria-hidden="true">ğŸŒ</span> 360Me Hubë¡œ ì´ë™
                </a>
            </div>
        </div>
    </section>

    {% set icon_map = {
        "ë§ì…ˆ": "â•",
        "ëº„ì…ˆ": "â–",
        "ê³±ì…ˆ": "âœ–ï¸",
        "ë‚˜ëˆ—ì…ˆ": "â—"
    } %}
    <nav aria-label="ì—°ì‚° ìœ í˜•" class="flex flex-wrap items-center justify-center gap-3">
        {% if categories %}
        {% for label in categories %}
        {% set icon = icon_map.get(label, "ğŸ“˜") %}
        <a href="/problems?category={{ label }}" class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition {% if label == category %}bg-primary text-slate-900 shadow-lg shadow-sky-900/30{% else %}border border-white/20 text-slate-200 hover:bg-white/10{% endif %}">
            <span aria-hidden="true">{{ icon }}</span> {{ label }}
        </a>
        {% endfor %}
        {% else %}
        <span class="rounded-full border border-white/20 px-4 py-2 text-sm font-semibold text-slate-300">í™œì„±í™”ëœ ë¬¸ì œ ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤</span>
        {% endif %}
    </nav>

    <section aria-labelledby="section-problems" class="space-y-6">
        <header>
            <h2 id="section-problems" class="text-2xl font-semibold text-white sm:text-3xl">ì´ {{ problems|length }}ê°œì˜ {{ category_display }} ë¬¸ì œ</h2>
            <p class="mt-2 text-sm text-slate-300">í¬ì»¤ìŠ¤ ì´ë™ê³¼ í‚¤ë³´ë“œ ì…ë ¥ì„ ì§€ì›í•˜ë©°, ì¦‰ì‹œ í”¼ë“œë°±ì´ ì œê³µë©ë‹ˆë‹¤.</p>
        </header>
        <div class="space-y-5" data-problem-list>
            {% for problem in problems %}
            <article class="rounded-2xl border border-white/10 bg-slate-900/70 p-6 shadow-lg shadow-sky-900/5" data-problem-card data-problem-index="{{ loop.index0 }}" data-problem-id="{{ problem.id }}">
                <header class="flex flex-wrap items-center justify-between gap-3">
                    <h3 class="text-xl font-semibold text-white">
                        <span class="mr-2 inline-flex h-9 w-9 items-center justify-center rounded-full bg-primary/20 text-base font-semibold text-primary">{{ loop.index }}</span>
                        ë¬¸ì œ {{ loop.index }}: {{ problem.question }}
                    </h3>
                    <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-semibold text-white/70">ì¦‰ì‹œ ì±„ì </span>
                </header>
                <form class="mt-5 flex flex-col gap-4 sm:flex-row sm:items-center" data-problem-form>
                    <label for="answer-{{ loop.index }}" class="flex-1">
                        <span class="sr-only">{{ problem.question }} ì •ë‹µ ì…ë ¥</span>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" id="answer-{{ loop.index }}" class="w-full rounded-xl border border-white/15 bg-slate-950/60 px-4 py-3 text-lg text-white placeholder:text-slate-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" data-input>
                    </label>
                    <button type="button" class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary px-5 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-sky-300" data-check>
                        <span aria-hidden="true">âœ…</span> ë‹µ í™•ì¸
                    </button>
                </form>
                <p class="mt-3 text-sm text-slate-300" data-feedback role="status"></p>
            </article>
            {% endfor %}
        </div>
    </section>

    <section aria-labelledby="section-summary" class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-xl shadow-sky-900/10">
        <header class="flex flex-wrap items-center justify-between gap-3">
            <div>
                <h2 id="section-summary" class="text-2xl font-semibold text-white">í•™ìŠµ ê²°ê³¼ ìš”ì•½</h2>
                <p class="mt-1 text-sm text-slate-300">ì •ë‹µ ìˆ˜ì™€ ì •í™•ë„ë¥¼ í™•ì¸í•˜ê³ , Invite ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ì¤€ë¹„ë¥¼ ë§ˆì¹©ë‹ˆë‹¤.</p>
            </div>
            <button type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-xs font-semibold text-white transition hover:bg-white/10" data-reset>
                <span aria-hidden="true">ğŸ”„</span> ê²°ê³¼ ì´ˆê¸°í™”
            </button>
        </header>
        <dl class="mt-6 grid gap-4 sm:grid-cols-3 text-center">
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì´ ë¬¸ì œ</dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-total">{{ problems|length }}</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì •ë‹µ ìˆ˜</dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-correct">0</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì •ë‹µë¥ </dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-accuracy">0%</dd>
            </div>
        </dl>
        <p class="mt-4 text-xs text-slate-400">Tip: ì •ë‹µë¥  80% ì´ìƒì´ë©´ Invite ë§í¬ë¥¼ ìƒì„±í•´ ì¹œêµ¬ë‚˜ ê°€ì¡±ê³¼ í•¨ê»˜ í’€ì–´ë³´ì„¸ìš”.</p>
    </section>

    <section id="invite" data-invite-section data-category="{{ category or '' }}" data-category-available="{{ 'true' if category_available else 'false' }}" tabindex="-1" class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-xl shadow-sky-900/10 focus:outline-none">
        <header class="flex flex-wrap items-center justify-between gap-3">
            <div>
                <h2 class="text-2xl font-semibold text-white">Invite ë§í¬ ê³µìœ </h2>
                <p class="mt-1 text-sm text-slate-300">í˜„ì¬ ìŠ¤í…Œì´ì§€ ì§„í–‰ ìƒí™©ì„ ê³µìœ í•˜ê³ , ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ì—ê²Œ {{ category_display }} ë¬¸ì œë¥¼ ì´ˆëŒ€í•˜ì„¸ìš”.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button type="button" class="inline-flex items-center gap-2 rounded-full bg-primary px-4 py-2 text-xs font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-sky-300 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60" data-invite-generate data-label-default="ì´ˆëŒ€ ë§í¬ ìƒì„±" data-label-refresh="ì´ˆëŒ€ ë§í¬ ë‹¤ì‹œ ìƒì„±">
                    <span aria-hidden="true">ğŸ¤</span>
                    <span data-label>ì´ˆëŒ€ ë§í¬ ìƒì„±</span>
                </button>
                <button type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-xs font-semibold text-white transition hover:bg-white/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60" data-invite-copy disabled>
                    <span aria-hidden="true">ğŸ“‹</span> ë§í¬ ë³µì‚¬
                </button>
                <button type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-xs font-semibold text-white/70 transition hover:bg-white/10 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60" data-invite-expire disabled>
                    <span aria-hidden="true">ğŸ—‘ï¸</span> ì´ˆëŒ€ ë§Œë£Œ
                </button>
            </div>
        </header>
        <p class="mt-4 text-sm text-slate-300" data-invite-status role="status">
            {% if category_available %}
            ì •ë‹µë¥ ì„ í™•ì¸í•œ ë’¤ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”.
            {% else %}
            ë¬¸ì œ ìœ í˜•ì„ ì„ íƒí•´ì•¼ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìƒë‹¨ì—ì„œ ì¹´í…Œê³ ë¦¬ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.
            {% endif %}
        </p>
        <div class="mt-6 hidden gap-6 lg:grid lg:grid-cols-[1.3fr_1fr]" data-invite-result>
            <div class="rounded-2xl border border-white/10 bg-white/5 p-6">
                <h3 class="text-lg font-semibold text-white">ê³µìœ  ë§í¬</h3>
                <a data-invite-url href="#" target="_blank" rel="noopener" class="mt-3 inline-block break-all text-sm text-sky-300 underline underline-offset-4">ì´ˆëŒ€ ë§í¬ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</a>
                <p class="mt-3 text-xs text-slate-300">ë§Œë£Œ ì˜ˆì •: <span data-invite-expiry>â€”</span></p>
                <dl class="mt-6 grid grid-cols-3 gap-3 text-center">
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">ì´ ë¬¸ì œ</dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-total>0</dd>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">ì •ë‹µ</dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-correct>0</dd>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 px-3 py-4">
                        <dt class="text-[0.7rem] font-medium uppercase tracking-[0.2em] text-slate-400">ì •ë‹µë¥ </dt>
                        <dd class="mt-2 text-xl font-semibold text-white" data-invite-summary-accuracy>0%</dd>
                    </div>
                </dl>
            </div>
            <div class="flex flex-col items-center justify-center gap-4 rounded-2xl border border-white/10 bg-white/5 p-6 text-center">
                <p class="text-sm text-slate-300">QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì´ˆëŒ€ ë§í¬ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <img data-invite-qr src="" alt="ì´ˆëŒ€ ë§í¬ QR ì½”ë“œ" class="hidden h-44 w-44 rounded-xl border border-white/20 bg-white/80 p-3 shadow-lg shadow-sky-900/20" loading="lazy" />
            </div>
        </div>
    </section>
</div>

<script>
const problemCards = Array.from(document.querySelectorAll('[data-problem-card]'));
const problemData = {{ problems|tojson }};
const summaryCorrect = document.getElementById('summary-correct');
const summaryAccuracy = document.getElementById('summary-accuracy');
const summaryTotal = document.getElementById('summary-total');
const answered = new Map();

function renderSummary() {
    const correctCount = Array.from(answered.values()).reduce((acc, value) => acc + (value ? 1 : 0), 0);
    const total = problemData.length || problemCards.length;
    const accuracy = total === 0 ? 0 : Math.round((correctCount / total) * 100);
    if (summaryCorrect) {
        summaryCorrect.textContent = String(correctCount);
    }
    if (summaryAccuracy) {
        summaryAccuracy.textContent = `${accuracy}%`;
    }
    if (summaryTotal) {
        summaryTotal.textContent = String(total);
    }
}

function setFeedback(feedbackEl, message, toneClass) {
    if (!feedbackEl) {
        return;
    }
    feedbackEl.textContent = message;
    feedbackEl.className = `mt-3 text-sm font-semibold ${toneClass}`;
}

function extractErrorMessage(payload) {
    if (!payload) {
        return 'ë‹µì•ˆì„ ì±„ì í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
    if (typeof payload.detail === 'string') {
        return payload.detail;
    }
    if (Array.isArray(payload.detail) && payload.detail[0]?.msg) {
        return payload.detail[0].msg;
    }
    if (payload.detail && typeof payload.detail.detail === 'string') {
        return payload.detail.detail;
    }
    if (typeof payload.message === 'string') {
        return payload.message;
    }
    return 'ë‹µì•ˆì„ ì±„ì í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
}

async function submitAttempt(problemId, answer) {
    const response = await fetch(`/api/problems/${encodeURIComponent(problemId)}/attempts`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        },
        body: JSON.stringify({ answer }),
    });

    let payload = null;
    const contentType = response.headers.get('content-type') ?? '';
    if (contentType.includes('application/json')) {
        payload = await response.json();
    }

    if (!response.ok) {
        const error = new Error(extractErrorMessage(payload));
        error.payload = payload;
        error.status = response.status;
        throw error;
    }

    return payload;
}

async function handleCheck(card) {
    const button = card.querySelector('[data-check]');
    const input = card.querySelector('[data-input]');
    const feedback = card.querySelector('[data-feedback]');
    const problemId = card.dataset.problemId ?? '';
    const rawValue = input?.value ?? '';
    const trimmed = rawValue.trim();
    const userAnswer = Number(trimmed);

    if (!problemId) {
        setFeedback(feedback, 'ë¬¸ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text-amber-300');
        return;
    }

    if (trimmed === '' || !Number.isFinite(userAnswer)) {
        setFeedback(feedback, 'ë‹µì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'text-amber-300');
        answered.delete(problemId);
        renderSummary();
        return;
    }

    if (button) {
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
    }

    try {
        const payload = await submitAttempt(problemId, userAnswer);
        const isCorrect = Boolean(payload?.is_correct);
        if (isCorrect) {
            setFeedback(feedback, 'ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš” ğŸ‰', 'text-emerald-300');
        } else {
            const correctAnswer = payload?.correct_answer;
            const hint = correctAnswer !== undefined ? `ì •ë‹µì€ ${correctAnswer} ì…ë‹ˆë‹¤.` : 'ë‹¤ì‹œ í•œë²ˆ ë„ì „í•´ë³´ì„¸ìš”!';
            setFeedback(feedback, `ì˜¤ë‹µì…ë‹ˆë‹¤. ${hint}`, 'text-rose-300');
        }
        answered.set(problemId, isCorrect);
    } catch (error) {
        const message = error instanceof Error ? error.message : 'ë‹µì•ˆì„ ì±„ì í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        setFeedback(feedback, message, 'text-amber-300');
        answered.delete(problemId);
    } finally {
        if (button) {
            button.disabled = false;
            button.removeAttribute('aria-busy');
        }
        renderSummary();
    }
}

function bindCard(card) {
    const button = card.querySelector('[data-check]');
    const input = card.querySelector('[data-input]');
    const correctAnswer = problemData[index]?.answer;
    if (!button || typeof correctAnswer === 'undefined') {
        return;
    }
    button.addEventListener('click', () => {
        void handleCheck(card);
    });
    if (input) {
        input.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                void handleCheck(card);
            }
        });
    }
}

problemCards.forEach(bindCard);
renderSummary();

const resetButton = document.querySelector('[data-reset]');
if (resetButton) {
    resetButton.addEventListener('click', () => {
        answered.clear();
        problemCards.forEach((card) => {
            const input = card.querySelector('[data-input]');
            const feedback = card.querySelector('[data-feedback]');
            if (input) {
                input.value = '';
            }
            if (feedback) {
                feedback.textContent = '';
                feedback.className = 'mt-3 text-sm text-slate-300';
            }
        });
        renderSummary();
    });
}

const inviteSection = document.querySelector('[data-invite-section]');
if (inviteSection) {
    const rawCategoryName = (inviteSection.dataset.category ?? '').trim();
    const hasValidCategory = (inviteSection.dataset.categoryAvailable ?? 'false') === 'true' && rawCategoryName !== '';
    const categoryName = hasValidCategory ? rawCategoryName : null;
    const inviteGenerateButton = inviteSection.querySelector('[data-invite-generate]');
    const inviteCopyButton = inviteSection.querySelector('[data-invite-copy]');
    const inviteExpireButton = inviteSection.querySelector('[data-invite-expire]');
    const inviteResult = inviteSection.querySelector('[data-invite-result]');
    const inviteStatus = inviteSection.querySelector('[data-invite-status]');
    const inviteUrlElement = inviteSection.querySelector('[data-invite-url]');
    const inviteExpiryElement = inviteSection.querySelector('[data-invite-expiry]');
    const inviteQrImage = inviteSection.querySelector('[data-invite-qr]');
    const inviteSummaryTotal = inviteSection.querySelector('[data-invite-summary-total]');
    const inviteSummaryCorrect = inviteSection.querySelector('[data-invite-summary-correct]');
    const inviteSummaryAccuracy = inviteSection.querySelector('[data-invite-summary-accuracy]');
    const inviteGenerateLabel = inviteGenerateButton?.querySelector('[data-label]');
    let inviteState = null;

    const defaultLabel = inviteGenerateButton?.dataset.labelDefault ?? 'ì´ˆëŒ€ ë§í¬ ìƒì„±';
    const refreshLabel = inviteGenerateButton?.dataset.labelRefresh ?? 'ì´ˆëŒ€ ë§í¬ ë‹¤ì‹œ ìƒì„±';

    function setInviteStatus(message, tone = 'info') {
        if (!inviteStatus) {
            return;
        }
        const baseClass = 'mt-4 text-sm font-medium';
        const toneClass = {
            success: 'text-emerald-300',
            error: 'text-rose-300',
            warning: 'text-amber-300',
            info: 'text-slate-300',
            neutral: 'text-slate-400',
        }[tone] ?? 'text-slate-300';
        inviteStatus.className = `${baseClass} ${toneClass}`;
        inviteStatus.textContent = message;
    }

    function resetInviteState() {
        inviteState = null;
        if (inviteCopyButton) {
            inviteCopyButton.disabled = true;
        }
        if (inviteExpireButton) {
            inviteExpireButton.disabled = true;
        }
        if (inviteResult) {
            inviteResult.classList.add('hidden');
        }
        if (inviteGenerateButton && inviteGenerateLabel) {
            inviteGenerateButton.disabled = !hasValidCategory;
            if (inviteGenerateButton.disabled) {
                inviteGenerateButton.setAttribute('aria-disabled', 'true');
            } else {
                inviteGenerateButton.removeAttribute('aria-disabled');
            }
            inviteGenerateLabel.textContent = defaultLabel;
        }
        if (inviteUrlElement) {
            inviteUrlElement.textContent = 'ì´ˆëŒ€ ë§í¬ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            inviteUrlElement.setAttribute('href', '#');
        }
        if (inviteExpiryElement) {
            inviteExpiryElement.textContent = 'â€”';
        }
        if (inviteQrImage) {
            inviteQrImage.classList.add('hidden');
            inviteQrImage.removeAttribute('src');
        }
        if (inviteSummaryTotal) {
            inviteSummaryTotal.textContent = '0';
        }
        if (inviteSummaryCorrect) {
            inviteSummaryCorrect.textContent = '0';
        }
        if (inviteSummaryAccuracy) {
            inviteSummaryAccuracy.textContent = '0%';
        }
    }

    function toggleGenerateLoading(isLoading) {
        if (!inviteGenerateButton || !inviteGenerateLabel) {
            return;
        }
        const shouldDisable = isLoading || !hasValidCategory;
        inviteGenerateButton.disabled = shouldDisable;
        if (shouldDisable) {
            inviteGenerateButton.setAttribute('aria-disabled', 'true');
        } else {
            inviteGenerateButton.removeAttribute('aria-disabled');
        }
        if (isLoading) {
            inviteGenerateLabel.textContent = 'ìƒì„± ì¤‘â€¦';
        } else if (inviteState) {
            inviteGenerateLabel.textContent = refreshLabel;
        } else {
            inviteGenerateLabel.textContent = defaultLabel;
        }
    }

    function computeInviteSummary() {
        const total = problemData.length || problemCards.length;
        const correct = Array.from(answered.values()).reduce((acc, value) => acc + (value ? 1 : 0), 0);
        return { total, correct };
    }

    function formatDateTime(isoString) {
        try {
            const locale = navigator.language || 'ko-KR';
            const formatter = new Intl.DateTimeFormat(locale, { dateStyle: 'medium', timeStyle: 'short' });
            return formatter.format(new Date(isoString));
        } catch (error) {
            return isoString;
        }
    }

    function updateInviteState(data) {
        inviteState = data;
        if (inviteResult) {
            inviteResult.classList.remove('hidden');
        }
        if (inviteCopyButton) {
            inviteCopyButton.disabled = false;
        }
        if (inviteExpireButton) {
            inviteExpireButton.disabled = false;
        }
        if (inviteUrlElement && data.share_url) {
            inviteUrlElement.textContent = data.share_url;
            inviteUrlElement.setAttribute('href', data.share_url);
        }
        if (inviteExpiryElement && data.expires_at) {
            inviteExpiryElement.textContent = formatDateTime(data.expires_at);
        }
        if (inviteQrImage && data.share_url) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(data.share_url)}`;
            inviteQrImage.setAttribute('src', qrUrl);
            inviteQrImage.classList.remove('hidden');
        }
        if (inviteSummaryTotal && data.summary?.total != null) {
            inviteSummaryTotal.textContent = String(data.summary.total);
        }
        if (inviteSummaryCorrect && data.summary?.correct != null) {
            inviteSummaryCorrect.textContent = String(data.summary.correct);
        }
        if (inviteSummaryAccuracy && data.summary?.accuracy != null) {
            inviteSummaryAccuracy.textContent = `${data.summary.accuracy}%`;
        }
    }

    async function handleInviteGenerate() {
        if (!inviteGenerateButton) {
            return;
        }
        if (!hasValidCategory || !categoryName) {
            setInviteStatus('í˜„ì¬ í™œì„±í™”ëœ ë¬¸ì œ ìœ í˜•ì´ ì—†ì–´ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            toggleGenerateLoading(false);
            return;
        }
        toggleGenerateLoading(true);
        setInviteStatus('ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
        try {
            const payload = {
                category: categoryName,
                summary: computeInviteSummary(),
            };
            const response = await fetch('/api/invites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                const errorMessage = errorBody.detail ?? 'ì´ˆëŒ€ ë§í¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                throw new Error(errorMessage);
            }
            const data = await response.json();
            updateInviteState(data);
            setInviteStatus('ì´ˆëŒ€ ë§í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë§í¬ë¥¼ ë³µì‚¬í•˜ê±°ë‚˜ QR ì½”ë“œë¥¼ ê³µìœ í•˜ì„¸ìš”!', 'success');
            toggleGenerateLoading(false);
        } catch (error) {
            console.error(error);
            setInviteStatus(error.message ?? 'ì´ˆëŒ€ ë§í¬ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            toggleGenerateLoading(false);
        }
    }

    async function handleInviteCopy() {
        if (!inviteState?.share_url) {
            return;
        }
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(inviteState.share_url);
                setInviteStatus('ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                const tempInput = document.createElement('input');
                tempInput.value = inviteState.share_url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                setInviteStatus('ë§í¬ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤.', 'success');
            }
        } catch (error) {
            console.error(error);
            setInviteStatus('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ ë³µì‚¬í•´ì£¼ì„¸ìš”.', 'warning');
        }
    }

    async function handleInviteExpire() {
        if (!inviteState?.token) {
            return;
        }
        setInviteStatus('ì´ˆëŒ€ ë§í¬ë¥¼ ë§Œë£Œ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...', 'info');
        try {
            const response = await fetch(`/api/invites/${inviteState.token}`, {
                method: 'DELETE',
            });
            if (!response.ok) {
                throw new Error('ì´ˆëŒ€ ë§Œë£Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            resetInviteState();
            setInviteStatus('ì´ˆëŒ€ ë§í¬ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ ìƒˆë¡œ ìƒì„±í•˜ì„¸ìš”.', 'neutral');
        } catch (error) {
            console.error(error);
            setInviteStatus(error.message ?? 'ì´ˆëŒ€ ë§í¬ ë§Œë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    if (inviteGenerateButton) {
        inviteGenerateButton.addEventListener('click', handleInviteGenerate);
    }
    if (inviteCopyButton) {
        inviteCopyButton.addEventListener('click', handleInviteCopy);
    }
    if (inviteExpireButton) {
        inviteExpireButton.addEventListener('click', handleInviteExpire);
    }

    resetInviteState();
    if (!hasValidCategory) {
        setInviteStatus('í˜„ì¬ ì„ íƒëœ ë¬¸ì œ ìœ í˜•ì´ ì—†ì–´ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
        return;
    }
    setInviteStatus('ì •ë‹µë¥ ì„ í™•ì¸í•œ ë’¤ ì´ˆëŒ€ ë§í¬ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”.', 'info');
}
</script>
{% endblock %}
