{% extends "base.html" %}

{% block title %}{{ category }} ë¬¸ì œ â€” 360Me Math Lab{% endblock %}

{% block content %}
<div class="mx-auto w-full max-w-5xl space-y-12 px-4 py-12 sm:px-6 lg:px-8">
    <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-sky-500 via-primary to-purple-500 px-6 py-14 text-white shadow-2xl sm:px-10">
        <div class="absolute inset-0 opacity-15" aria-hidden="true"
             style="background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.28) 0, transparent 55%),
                    radial-gradient(circle at 80% 10%, rgba(255,255,255,0.2) 0, transparent 45%);"></div>
        <div class="relative z-10 space-y-5 text-center">
            <span class="inline-flex items-center justify-center rounded-full bg-white/10 px-4 py-1 text-xs font-semibold uppercase tracking-widest text-white/80">
                Practice Stage Â· {{ category }} Â· WCAG 2.2 AA
            </span>
            <h1 class="text-4xl font-bold tracking-tight sm:text-5xl">{{ category }} ë¬¸ì œ ì—°ìŠµ</h1>
            <p class="text-base text-white/85 sm:text-lg">
                ë¬¸ì œë¥¼ ì½ê³  ë‹µì„ ì…ë ¥í•˜ë©´ ì¦‰ì‹œ í”¼ë“œë°±ì´ ì œê³µë©ë‹ˆë‹¤. Self â†’ Invite â†’ Aggregate ì—¬ì •ì˜ Practice ë‹¨ê³„ì— í•´ë‹¹í•©ë‹ˆë‹¤.
                ì •ë‹µë¥  ìš”ì•½ê³¼ í•™ìŠµ ë…¸íŠ¸ ë§í¬ë¡œ ë‹¤ìŒ ë‹¨ê³„ì— ëŒ€ë¹„í•˜ì„¸ìš”.
            </p>
            <div class="flex flex-wrap items-center justify-center gap-3">
                <a href="/" class="inline-flex items-center gap-2 rounded-full bg-white/90 px-4 py-2 text-sm font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-white">
                    <span aria-hidden="true">ğŸ </span> í—ˆë¸Œ í™ˆ
                </a>
                <a href="http://localhost:8080" class="inline-flex items-center gap-2 rounded-full border border-white/40 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/10">
                    <span aria-hidden="true">ğŸŒ</span> 360Me Hubë¡œ ì´ë™
                </a>
            </div>
        </div>
    </section>

    <nav aria-label="ì—°ì‚° ìœ í˜•" class="flex flex-wrap items-center justify-center gap-3">
        {% set nav_links = [
            ("ë§ì…ˆ", "â•"),
            ("ëº„ì…ˆ", "â–"),
            ("ê³±ì…ˆ", "âœ–ï¸"),
            ("ë‚˜ëˆ—ì…ˆ", "â—")
        ] %}
        {% for label, icon in nav_links %}
        <a href="/problems?category={{ label }}" class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition {% if label == category %}bg-primary text-slate-900 shadow-lg shadow-sky-900/30{% else %}border border-white/20 text-slate-200 hover:bg-white/10{% endif %}">
            <span aria-hidden="true">{{ icon }}</span> {{ label }}
        </a>
        {% endfor %}
    </nav>

    <section aria-labelledby="section-problems" class="space-y-6">
        <header>
            <h2 id="section-problems" class="text-2xl font-semibold text-white sm:text-3xl">ì´ {{ problems|length }}ê°œì˜ {{ category }} ë¬¸ì œ</h2>
            <p class="mt-2 text-sm text-slate-300">í¬ì»¤ìŠ¤ ì´ë™ê³¼ í‚¤ë³´ë“œ ì…ë ¥ì„ ì§€ì›í•˜ë©°, ì¦‰ì‹œ í”¼ë“œë°±ì´ ì œê³µë©ë‹ˆë‹¤.</p>
        </header>
        <div class="space-y-5" data-problem-list>
            {% for problem in problems %}
            <article class="rounded-2xl border border-white/10 bg-slate-900/70 p-6 shadow-lg shadow-sky-900/5" data-problem-card data-problem-index="{{ loop.index0 }}">
                <header class="flex flex-wrap items-center justify-between gap-3">
                    <h3 class="text-xl font-semibold text-white">
                        <span class="mr-2 inline-flex h-9 w-9 items-center justify-center rounded-full bg-primary/20 text-base font-semibold text-primary">{{ loop.index }}</span>
                        ë¬¸ì œ {{ loop.index }}: {{ problem.question }}
                    </h3>
                    <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-semibold text-white/70">ì¦‰ì‹œ ì±„ì </span>
                </header>
                <form class="mt-5 flex flex-col gap-4 sm:flex-row sm:items-center" data-problem-form>
                    <label for="answer-{{ loop.index }}" class="flex-1">
                        <span class="sr-only">{{ problem.question }} ì •ë‹µ ì…ë ¥</span>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" id="answer-{{ loop.index }}" class="w-full rounded-xl border border-white/15 bg-slate-950/60 px-4 py-3 text-lg text-white placeholder:text-slate-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" data-input>
                    </label>
                    <button type="button" class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary px-5 py-3 text-sm font-semibold text-slate-900 shadow-lg shadow-sky-900/30 transition hover:-translate-y-0.5 hover:bg-sky-300" data-check>
                        <span aria-hidden="true">âœ…</span> ë‹µ í™•ì¸
                    </button>
                </form>
                <p class="mt-3 text-sm text-slate-300" data-feedback role="status"></p>
            </article>
            {% endfor %}
        </div>
    </section>

    <section aria-labelledby="section-summary" class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-xl shadow-sky-900/10">
        <header class="flex flex-wrap items-center justify-between gap-3">
            <div>
                <h2 id="section-summary" class="text-2xl font-semibold text-white">í•™ìŠµ ê²°ê³¼ ìš”ì•½</h2>
                <p class="mt-1 text-sm text-slate-300">ì •ë‹µ ìˆ˜ì™€ ì •í™•ë„ë¥¼ í™•ì¸í•˜ê³ , Invite ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ì¤€ë¹„ë¥¼ ë§ˆì¹©ë‹ˆë‹¤.</p>
            </div>
            <button type="button" class="inline-flex items-center gap-2 rounded-full border border-white/20 px-4 py-2 text-xs font-semibold text-white transition hover:bg-white/10" data-reset>
                <span aria-hidden="true">ğŸ”„</span> ê²°ê³¼ ì´ˆê¸°í™”
            </button>
        </header>
        <dl class="mt-6 grid gap-4 sm:grid-cols-3 text-center">
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì´ ë¬¸ì œ</dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-total">{{ problems|length }}</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì •ë‹µ ìˆ˜</dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-correct">0</dd>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-5">
                <dt class="text-xs font-medium uppercase tracking-[0.2em] text-slate-300">ì •ë‹µë¥ </dt>
                <dd class="mt-3 text-3xl font-semibold text-white" id="summary-accuracy">0%</dd>
            </div>
        </dl>
        <p class="mt-4 text-xs text-slate-400">Tip: ì •ë‹µë¥  80% ì´ìƒì´ë©´ Invite ë§í¬ë¥¼ ìƒì„±í•´ ì¹œêµ¬ë‚˜ ê°€ì¡±ê³¼ í•¨ê»˜ í’€ì–´ë³´ì„¸ìš”.</p>
    </section>
</div>

<script>
const problemCards = Array.from(document.querySelectorAll('[data-problem-card]'));
const summaryCorrect = document.getElementById('summary-correct');
const summaryAccuracy = document.getElementById('summary-accuracy');
const summaryTotal = document.getElementById('summary-total');
const answered = new Map();

function renderSummary() {
    const correctCount = Array.from(answered.values()).reduce((acc, value) => acc + (value ? 1 : 0), 0);
    const total = Number(summaryTotal?.textContent ?? problemCards.length) || problemCards.length;
    const accuracy = total === 0 ? 0 : Math.round((correctCount / total) * 100);
    if (summaryCorrect) {
        summaryCorrect.textContent = String(correctCount);
    }
    if (summaryAccuracy) {
        summaryAccuracy.textContent = `${accuracy}%`;
    }
}

function handleCheck(card, index, correctAnswer) {
    const input = card.querySelector('[data-input]');
    const feedback = card.querySelector('[data-feedback]');
    const rawValue = input?.value ?? '';
    const userAnswer = Number(rawValue);
    if (!Number.isFinite(userAnswer) || rawValue.trim() === '') {
        if (feedback) {
            feedback.textContent = 'ë‹µì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            feedback.className = 'mt-3 text-sm font-semibold text-amber-300';
        }
        answered.delete(index);
        renderSummary();
        return;
    }

    const isCorrect = userAnswer === Number(correctAnswer);
    if (feedback) {
        if (isCorrect) {
            feedback.textContent = 'ì •ë‹µì…ë‹ˆë‹¤! ì˜í–ˆì–´ìš” ğŸ‰';
            feedback.className = 'mt-3 text-sm font-semibold text-emerald-300';
        } else {
            feedback.textContent = `ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µì€ ${correctAnswer} ì…ë‹ˆë‹¤.`;
            feedback.className = 'mt-3 text-sm font-semibold text-rose-300';
        }
    }
    answered.set(index, isCorrect);
    renderSummary();
}

function bindCard(card) {
    const index = Number(card.dataset.problemIndex ?? '0');
    const button = card.querySelector('[data-check]');
    const input = card.querySelector('[data-input]');
    const correctAnswer = {{ problems|tojson }}[index]?.answer;
    if (!button || typeof correctAnswer === 'undefined') {
        return;
    }
    button.addEventListener('click', () => handleCheck(card, index, correctAnswer));
    if (input) {
        input.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleCheck(card, index, correctAnswer);
            }
        });
    }
}

problemCards.forEach(bindCard);
renderSummary();

const resetButton = document.querySelector('[data-reset]');
if (resetButton) {
    resetButton.addEventListener('click', () => {
        answered.clear();
        problemCards.forEach((card) => {
            const input = card.querySelector('[data-input]');
            const feedback = card.querySelector('[data-feedback]');
            if (input) {
                input.value = '';
            }
            if (feedback) {
                feedback.textContent = '';
                feedback.className = 'mt-3 text-sm text-slate-300';
            }
        });
        renderSummary();
    });
}
</script>
{% endblock %}
